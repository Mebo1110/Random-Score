<script>
    let POINT_LIMIT = parseInt(localStorage.getItem('POINT_LIMIT')) || 5;
    let GAME_LIMIT = parseInt(localStorage.getItem('GAME_LIMIT')) || 4;
    let ANGRY_MODE = localStorage.getItem('ANGRY_MODE') === null ? true : localStorage.getItem('ANGRY_MODE') === 'true';
    
    let stats = { A: { score: 0, games: 0 }, B: { score: 0, games: 0 } };

    // --- KEYBOARD SHORTCUTS ---
    window.onkeydown = (e) => {
        // If you are typing in a name box, don't trigger the score
        if (e.target.tagName === 'INPUT' && e.target.type === 'text') return;

        if (e.key === "1") {
            addA(1);
        } else if (e.key === "2") {
            addB(1);
        } else if (e.code === "ArrowLeft") {
            addA(1);
        } else if (e.code === "ArrowRight") {
            addB(1);
        }
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let parts = [];

    function animate() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        parts.forEach((p, i) => {
            p.y += p.vy; p.x += Math.sin(p.wobble) * 2; p.wobble += 0.1;
            p.vy += 0.2; p.l -= 0.008;
            ctx.globalAlpha = p.l; ctx.fillStyle = p.c;
            ctx.fillRect(p.x, p.y, p.w, p.h);
            if(p.l <= 0) parts.splice(i, 1);
        });
        requestAnimationFrame(animate);
    }
    window.onresize = () => { canvas.width = innerWidth; canvas.height = innerHeight; };
    window.onresize(); animate();

    function showCelebration(name, mode) {
        const lowerName = name.toLowerCase().trim();
        const isRoast = lowerName === 'ragav' || (ANGRY_MODE && !['connor', 'mebo'].includes(lowerName));
        const overlay = document.getElementById('overlay');
        overlay.style.display = 'flex';
        document.getElementById('winMessage').textContent = mode === 'game' ? "GAME WON!" : "CHAMPIONSHIP!";
        document.getElementById('champName').textContent = name;
        document.getElementById('roast').style.display = isRoast ? 'block' : 'none';
        
        if(isRoast) {
            document.getElementById('winMessage').className = "win-text wimpy-text";
            document.getElementById('roast').textContent = mode === 'game' ? "(your still bad cheater. don't get cocky.)" : "(whatever bruv)";
            for(let i=0; i<(mode === 'game' ? 1 : 3); i++) {
                parts.push({ x: innerWidth/2, y: innerHeight/2, w: 40, h: 50, c: '#555', vy: -5, l: 1.5, wobble: Math.random() });
            }
        } else {
            document.getElementById('winMessage').className = "win-text";
            for(let i=0; i<(mode === 'champ' ? 150 : 50); i++) {
                parts.push({ x: innerWidth/2, y: innerHeight/2, w: Math.random()*30+20, h: Math.random()*30+20, c: `hsl(${Math.random()*360},70%,60%)`, vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20, l: 1, wobble: Math.random()*10 });
            }
        }
        setTimeout(() => overlay.style.display = 'none', mode === 'game' ? 2000 : 4000);
    }

    function processPoint(winner, amount) {
        stats[winner].score += amount;
        if(stats[winner].score >= POINT_LIMIT) {
            stats.A.score = 0; stats.B.score = 0;
            stats[winner].games++;
            if(stats[winner].games >= GAME_LIMIT) {
                stats.A.games = 0; stats.B.games = 0;
                showCelebration(document.getElementById(`name${winner}`).value, 'champ');
            } else {
                showCelebration(document.getElementById(`name${winner}`).value, 'game');
            }
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById('scoreA').textContent = stats.A.score;
        document.getElementById('scoreB').textContent = stats.B.score;
        document.getElementById('gamesA').textContent = stats.A.games;
        document.getElementById('gamesB').textContent = stats.B.games;
        document.getElementById('labelA').textContent = document.getElementById('nameA').value || 'Team A';
        document.getElementById('labelB').textContent = document.getElementById('nameB').value || 'Team B';
    }

    function addA(amt) { processPoint('A', amt); }
    function addB(amt) { processPoint('B', amt); }
    function subA() { if(stats.A.score > 0) stats.A.score--; updateUI(); }
    function subB() { if(stats.B.score > 0) stats.B.score--; updateUI(); }

    function openSettings() { document.getElementById('settingsModal').style.display = 'block'; }
    function closeSettings() { 
        POINT_LIMIT = parseInt(document.getElementById('setPointLimit').value); 
        GAME_LIMIT = parseInt(document.getElementById('setGameLimit').value);
        ANGRY_MODE = document.getElementById('angryModeToggle').checked;
        localStorage.setItem('POINT_LIMIT', POINT_LIMIT);
        localStorage.setItem('GAME_LIMIT', GAME_LIMIT);
        localStorage.setItem('ANGRY_MODE', ANGRY_MODE);
        document.getElementById('settingsModal').style.display = 'none'; 
    }
    function fullReset() { if(confirm("Wipe all data?")) { localStorage.clear(); location.reload(); } }
</script>
